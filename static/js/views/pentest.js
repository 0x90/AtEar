define(
['jquery','lodash','backbone','semantic','utils/tpl',
'models/scanstatus-collection',
'models/pentest-model',
'views/pentest-scantable',
'views/pentest-typetable',
'views/pentest-option'],

function($,_,Backbone,$,tpl,ScanStatuses, Pentest, PentestScanTableView, PentestTypeTableView, PentestOptionView) {

	var PentestView = Backbone.View.extend({

		initialize: function(){
			this.template = _.template(tpl.get('pentest'));
			
		},

		render: function(){
			this.setElement(this.template());
			return this.el;
		},

		events: {
			"click .to-step-one.button" : "stepOne",
			"click .to-step-two.button" : "stepTwo",
			"click .to-step-start.button" : "stepStart"
		},

		afterRender: function(){
			var scannedAP = this.getScannedAP();
			
			if ( scannedAP ) {
				if( this.apList==undefined ) {
					this.apList = new ScanStatuses(scannedAP,{ id:1 });
				}
				this.apTableView = new PentestScanTableView({
					model : this.apList
				});
				this.$el.find('.ap-table').html(this.apTableView.render().el);
			}

			this.typeTableView = new PentestTypeTableView();
			this.$el.find('.type-table').html(this.typeTableView.render().el);

			this.optionView = new PentestOptionView();
			this.$el.find('.option').html(this.optionView.render().el);

			this.stepOne();
		},

		getScannedAP: function(){
			var data = localStorage.getItem('scannedAP');
			if( data == null) {
				return false;
			} else {
				var json_data = JSON.parse(data);
				var filtered_data = _.filter(json_data,function(d){
					return d.type != "ad-hoc" && d.type != "station";
				});
				return filtered_data;
			}
		},

		stepOne: function() {
			this.$el.find('.steps .active').removeClass('active');
			this.$el.find('.steps .step.one').addClass('active');
			if( this.$el.find('.pentest-step.active').length>0 ) {
				this.$el.find('.pentest-step.active').removeClass('active').transition({
					animation: 'fade right',
					onHide: function(){
						$('.pentest-step.one').addClass('active').transition('fade left');
					}
				});
			} else {
				$('.pentest-step.one').addClass('active').transition('fade left');
			}

			
		},

		stepTwo: function() {
			this.$el.find('.steps .active').removeClass('active');
			this.$el.find('.steps .step.two').addClass('active');
			this.$el.find('.pentest-step.active').removeClass('active').transition({
				animation: 'fade right',
				onHide: function(){
					$('.pentest-step.two').addClass('active').transition('fade left');
				}
			});
		},

		stepStart: function() {
			this.setPentestOption();
			this.loadingModal();
		},

		setPentestOption: function() {
			this.pentest = new Pentest();
			this.pentest.set(this.apTableView.getValue());
			this.pentest.set(this.optionView.getValue());

			console.log(this.pentest.toJSON());
		},

		loadingModal: function() {
			var self = this;
			$('.pentest-loading.modal').modal({
				closable:false,
				onDeny:function(){
					console.log('on deny');
				}
			}).modal('show');

			$('.ui.progress').progress();
		}

	});
	
	return PentestView;

});